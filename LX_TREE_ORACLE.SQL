-- 组织架构类目 
SELECT
 DISTINCT EAS_ORG_LEVEL, EAS_ORG_CODE,EAS_ORG_NAME,EAS_ORG_ID,EAS_SUP_ORG_ID
FROM
 V_MID_BI_ORG
WHERE
 EAS_ORG_ID IN (
  SELECT
   AUTH_ORG_ID
  FROM
   FILL_USER_AUTHORITY T1
  LEFT JOIN DIM_EAS_ORG T2 ON T1.AUTH_ORG_ID = T2.ORG_ID
  WHERE
   USER_CODE = '${fine_username}'
  UNION ALL
   SELECT
    ORG_ID
   FROM
    DIM_EAS_ORG START WITH SUP_ORG_ID IN (
     SELECT
      AUTH_ORG_ID
     FROM
      FILL_USER_AUTHORITY
     WHERE
      USER_CODE = '${fine_username}'
    ) CONNECT BY PRIOR ORG_ID = SUP_ORG_ID
 )
 ORDER BY EAS_ORG_LEVEL,EAS_ORG_CODE DESC 
 
 -- 流向组织架构类目
 SELECT
 DISTINCT LX_ORG_ID,LX_ORG_NAME,LX_SUP_ORG_ID
FROM
 V_MID_BI_ORG
WHERE
 EAS_ORG_ID IN (
  SELECT
   AUTH_ORG_ID
  FROM
   FILL_USER_AUTHORITY T1
  LEFT JOIN DIM_EAS_ORG T2 ON T1.AUTH_ORG_ID = T2.ORG_ID
  WHERE
   USER_CODE = '${fine_username}'
  UNION ALL
   SELECT
    ORG_ID
   FROM
    DIM_EAS_ORG START WITH SUP_ORG_ID IN (
     SELECT
      AUTH_ORG_ID
     FROM
      FILL_USER_AUTHORITY
     WHERE
      USER_CODE = '${fine_username}'
    ) CONNECT BY PRIOR ORG_ID = SUP_ORG_ID
 )
 ORDER BY LX_ORG_NAME,LX_ORG_ID
 
 
 -- DM_LX_TREE->SALE
 SELECT DISTINCT
 T3.LX_CUST_ORG_ID,
 T3.LX_TERM_ORG_ID,
 T3.CUST_TYPE,
 T3.BU_TYPE,
 T3.BU_TERM_TYPE,
 SUM(NVL(T3.SALE_MONEY/'${tth_hex}',0)) OVER (
			PARTITION BY  T3.LX_CUST_ORG_ID,
 T3.LX_TERM_ORG_ID,
 T3.CUST_TYPE,
 T3.BU_TYPE,
 T3.BU_TERM_TYPE		
		)SALE_MONEY
FROM
 DM_LX_TREE T3
WHERE 1=1
 AND T3.LX_CUST_ORG_ID IN (
SELECT DISTINCT
  LX_ORG_ID
 FROM
  V_MID_BI_ORG
  START WITH LX_ORG_ID IN
${"("+"'"+replace(gArea,',',"','")+"'"+")"}
   CONNECT BY PRIOR LX_ORG_ID = LX_SUP_ORG_ID
)
 AND T3.FILL_CODE IN ${"("+"'"+replace(gProductType,',',"','")+"'"+")"}
 AND T3.SALE_MONTH BETWEEN '${start_date}' AND '${end_date}' 
 UNION
  SELECT DISTINCT
T3.LX_CUST_ORG_ID,
 T3.LX_TERM_ORG_ID,
 T3.CUST_TYPE,
 T3.BU_TYPE,
 T3.BU_TERM_TYPE,
 SUM(NVL(T3.SALE_MONEY/'${tth_hex}',0)) OVER (
			PARTITION BY T3.LX_CUST_ORG_ID,
 T3.LX_TERM_ORG_ID,
 T3.CUST_TYPE,
 T3.BU_TYPE,
 T3.BU_TERM_TYPE
		)SALE_MONEY
FROM
 DM_LX_TREE T3
WHERE 1=1
 AND T3.LX_TERM_ORG_ID IN (
SELECT DISTINCT
  LX_ORG_ID
 FROM
  V_MID_BI_ORG
  START WITH LX_ORG_ID IN
${"("+"'"+replace(gArea,',',"','")+"'"+")"}
   CONNECT BY PRIOR LX_ORG_ID = LX_SUP_ORG_ID
)
 AND T3.FILL_CODE IN ${"("+"'"+replace(gProductType,',',"','")+"'"+")"}
 AND T3.SALE_MONTH BETWEEN '${start_date}' AND '${end_date}' 


-- 流向树->STOCK
WITH T1 AS (
SELECT DISTINCT
  T1.LX_ORG_ID
 FROM
  V_MID_BI_ORG T1 
  START WITH LX_ORG_ID IN
${"("+"'"+replace(gArea,',',"','")+"'"+")"}
   CONNECT BY PRIOR LX_ORG_ID = LX_SUP_ORG_ID
) SELECT DISTINCT 
  T1.LX_ORG_ID,
  T3.CUST_TYPE,
  T3.FILL_CODE,
  T3.BU_PROD_NAME,
  SUM(ROUND(NVL(T3.PROD_MONEY_P/'${tth_hex}',0),1)) OVER(PARTITION BY T1.LX_ORG_ID,
  T3.CUST_TYPE,
  T3.FILL_CODE,
  T3.BU_PROD_NAME) PROD_MONEY_P,
  SUM(ROUND(NVL(T3.AVG_SALE_PROD_MONEY_P/'${tth_hex}',0),1)) OVER(PARTITION BY T1.LX_ORG_ID,
  T3.CUST_TYPE,
  T3.FILL_CODE,
  T3.BU_PROD_NAME)AVG_SALE_PROD_MONEY_P
FROM
  T1
INNER JOIN 
(SELECT DISTINCT
 T2.LX_CUST_ORG_ID,
 T2.CUST_TYPE,
 T2.PROD_CODE_P,
 SUM(NVL(T2.PROD_MONEY_P,0))OVER(PARTITION BY
 T2.LX_CUST_ORG_ID,
 T2.CUST_TYPE,
 T2.PROD_CODE_P) PROD_MONEY_P,
 SUM(NVL(T2.AVG_SALE_PROD_MONEY_P,0))OVER(PARTITION BY
 T2.LX_CUST_ORG_ID,
 T2.CUST_TYPE,
 T2.PROD_CODE_P) AVG_SALE_PROD_MONEY_P,
 T3.FILL_CODE,
 T3.BU_PROD_NAME
FROM
 DM_STOCKBYMONTH T2
INNER JOIN FILL_BUIN_LX_PROD_NAME T3 ON T2.PROD_CODE_P = T3.PROD_CODE
WHERE 1=1
AND T3.FILL_CODE IN ${"("+"'"+replace(gProductType,',',"','")+"'"+")"}
AND T2.STOCK_MONTH ='${end_date}' 
)T3 ON T1.LX_ORG_ID = T3.LX_CUST_ORG_ID


-- 流向树->STOCK_VAILID
WITH T1 AS (
SELECT DISTINCT
  T1.LX_ORG_ID
 FROM
  V_MID_BI_ORG T1 
  START WITH LX_ORG_ID IN
${"("+"'"+replace(gArea,',',"','")+"'"+")"}
   CONNECT BY PRIOR LX_ORG_ID = LX_SUP_ORG_ID
) SELECT DISTINCT 
  T1.LX_ORG_ID,
  T3.CUST_TYPE,
  T3.FILL_CODE,
  T3.VAILID_MONTH,
  SUM(ROUND(NVL(T3.PROD_MONEY_P/'${tth_hex}',0),1)) OVER(PARTITION BY 
  T1.LX_ORG_ID,
  T3.CUST_TYPE,
  T3.FILL_CODE,
  T3.VAILID_MONTH) PROD_MONEY_P
FROM
  T1
INNER JOIN 
(SELECT
 T1.STOCK_MONTH,
 T1.LX_CUST_ORG_ID,
 T1.CUST_TYPE,
 T1.PROD_CODE_P,
 MONTHS_BETWEEN(TO_DATE(CONCAT('${end_date}','-01'),'yyyy-mm-dd'), TO_DATE(T1.VALID_DATE,'yyyy-mm-dd')) AS VAILID_MONTH,
 T1.PROD_MONEY_P,
 T3.FILL_CODE
FROM
 DM_STOCKBYMONTH_TEMP T1
INNER JOIN FILL_BUIN_LX_PROD_NAME T3 ON T1.PROD_CODE_P = T3.PROD_CODE
WHERE T1.VALID_DATE IS NOT NULL
AND T3.FILL_CODE IN ${"("+"'"+replace(gProductType,',',"','")+"'"+")"}
AND T1.STOCK_MONTH ='${end_date}' 
)T3 ON T1.LX_ORG_ID = T3.LX_CUST_ORG_ID
WHERE
 T3.VAILID_MONTH<4
 
 
 
 
 -- 客户表-SALE_CUST
SELECT DISTINCT
 T3.LX_CUST_ORG_ID,
 T3.LX_TERM_ORG_ID,
 T3.LX_CUST_ID,
 T3.CUST_TYPE,
 T3.BU_TYPE,
 T3.BU_TERM_TYPE,
 SUM(NVL(T3.SALE_MONEY/'${tth_hex}',0)) OVER (
			PARTITION BY T3.LX_CUST_ORG_ID,
 T3.LX_TERM_ORG_ID,
 T3.LX_CUST_ID,
 T3.CUST_TYPE,
 T3.BU_TYPE,
 T3.BU_TERM_TYPE	
		)SALE_MONEY
FROM
 DM_LX_CUSTTREE T3
WHERE T3.CUST_TYPE = '${cust_type}'
 AND T3.LX_CUST_ORG_ID IN (
SELECT DISTINCT
  T1.ORG_ID
 FROM
  DIM_LX_ORG T1 
  START WITH ORG_ID  IN
${"("+"'"+replace(gArea,',',"','")+"'"+")"}
   CONNECT BY PRIOR ORG_ID = SUP_ORG_ID
)
 AND T3.FILL_CODE IN ${"("+"'"+replace(gProductType,',',"','")+"'"+")"}
 AND T3.SALE_MONTH BETWEEN '${start_date}' AND '${end_date}' 
 UNION
 SELECT DISTINCT
 T3.LX_CUST_ORG_ID,
 T3.LX_TERM_ORG_ID,
 T3.LX_CUST_ID,
 T3.CUST_TYPE,
 T3.BU_TYPE,
 T3.BU_TERM_TYPE,
 SUM(NVL(T3.SALE_MONEY/'${tth_hex}',0)) OVER (
			PARTITION BY T3.LX_CUST_ORG_ID,
 T3.LX_TERM_ORG_ID,
 T3.LX_CUST_ID,
 T3.CUST_TYPE,
 T3.BU_TYPE,
 T3.BU_TERM_TYPE	
		)SALE_MONEY
FROM
 DM_LX_CUSTTREE T3
WHERE T3.BU_TERM_TYPE = '${cust_type}'
 AND T3.LX_TERM_ORG_ID IN (
SELECT DISTINCT
  T1.ORG_ID
 FROM
  DIM_LX_ORG T1 
  START WITH ORG_ID  IN
${"("+"'"+replace(gArea,',',"','")+"'"+")"}
   CONNECT BY PRIOR ORG_ID = SUP_ORG_ID
)
 AND T3.FILL_CODE IN ${"("+"'"+replace(gProductType,',',"','")+"'"+")"}
 AND T3.SALE_MONTH BETWEEN '${start_date}' AND '${end_date}' 


-- 客户表- 客户筛选 
WITH T1 AS (
SELECT DISTINCT
  T1.ORG_ID LX_ORG_ID,
  T1.ORG_NAME LX_ORG_NAME,
  T1.SUP_ORG_ID
 FROM
  DIM_LX_ORG T1 
  START WITH ORG_ID IN
${"("+"'"+replace(gArea,',',"','")+"'"+")"} 
   CONNECT BY PRIOR ORG_ID = SUP_ORG_ID
)
SELECT DISTINCT
 T1.LX_ORG_ID,
 T2.LX_CUST_ID,
 T2.LX_CUST_NAME
FROM
 T1
INNER JOIN DM_LX_CUSTTREE T2 ON T1.LX_ORG_ID = T2.LX_CUST_ORG_ID
WHERE T2.CUST_TYPE = '${cust_type}'
AND T2.SALE_MONTH BETWEEN '${start_date}' AND '${end_date}' 


-- 客户数->STOCK
WITH T1 AS (
SELECT DISTINCT
  T1.ORG_ID LX_ORG_ID,
  T1.ORG_NAME LX_ORG_NAME,
  T1.SUP_ORG_ID
 FROM
  DIM_LX_ORG T1 
  START WITH ORG_ID IN
${"("+"'"+replace(gArea,',',"','")+"'"+")"}
   CONNECT BY PRIOR ORG_ID = SUP_ORG_ID
) SELECT DISTINCT 
  T1.LX_ORG_ID,
  T1.LX_ORG_NAME,
  T3.LX_CUST_ID,
  T3.CUST_TYPE,
  T3.FILL_CODE,
  T3.BU_PROD_NAME,
  SUM(ROUND(NVL(T3.PROD_MONEY_P/'${tth_hex}',0),1)) OVER(PARTITION BY T1.LX_ORG_ID,
  T1.LX_ORG_NAME,
  T3.LX_CUST_ID,
  T3.CUST_TYPE,
  T3.FILL_CODE,
  T3.BU_PROD_NAME) PROD_MONEY_P,
  SUM(ROUND(NVL(T3.AVG_SALE_PROD_MONEY_P/'${tth_hex}',0),1)) OVER(PARTITION BY T1.LX_ORG_ID,
  T1.LX_ORG_NAME,
  T3.LX_CUST_ID,
  T3.CUST_TYPE,
  T3.FILL_CODE,
  T3.BU_PROD_NAME)AVG_SALE_PROD_MONEY_P
FROM
  T1
INNER JOIN 
(SELECT DISTINCT
 T2.LX_CUST_ORG_ID,
 T2.LX_CUST_ID,
 T2.CUST_TYPE,
 T2.PROD_CODE_P,
 SUM(NVL(T2.PROD_MONEY_P,0))OVER(PARTITION BY
 T2.LX_CUST_ORG_ID,
 T2.LX_CUST_ID,
 T2.CUST_TYPE,
 T2.PROD_CODE_P) PROD_MONEY_P,
 SUM(NVL(T2.AVG_SALE_PROD_MONEY_P,0))OVER(PARTITION BY
 T2.LX_CUST_ORG_ID,
 T2.LX_CUST_ID,
 T2.CUST_TYPE,
 T2.PROD_CODE_P) AVG_SALE_PROD_MONEY_P,
 T3.FILL_CODE,
 T3.BU_PROD_NAME
FROM
 DM_STOCKBYMONTH T2
INNER JOIN FILL_BUIN_LX_PROD_NAME T3 ON T2.PROD_CODE_P = T3.PROD_CODE
WHERE 1=1
AND T3.FILL_CODE IN ${"("+"'"+replace(gProductType,',',"','")+"'"+")"}
AND T2.STOCK_MONTH ='${end_date}' 
)T3 ON T1.LX_ORG_ID = T3.LX_CUST_ORG_ID


-- 客户表->STOCK_VAILID
WITH T1 AS (
SELECT DISTINCT
  T1.ORG_ID LX_ORG_ID,
  T1.ORG_NAME LX_ORG_NAME,
  T1.SUP_ORG_ID
 FROM
  DIM_LX_ORG T1 
  START WITH ORG_ID IN
${"("+"'"+replace(gArea,',',"','")+"'"+")"}
   CONNECT BY PRIOR ORG_ID = SUP_ORG_ID
) SELECT DISTINCT 
  T1.LX_ORG_ID,
  T3.LX_CUST_ID,
  T3.CUST_TYPE,
  T3.FILL_CODE,
  T3.VAILID_MONTH,
  SUM(ROUND(NVL(T3.PROD_MONEY_P/'${tth_hex}',0),1)) OVER(PARTITION BY 
  T1.LX_ORG_ID,
  T3.LX_CUST_ID,
  T3.CUST_TYPE,
  T3.FILL_CODE,
  T3.VAILID_MONTH) PROD_MONEY_P
FROM
  T1
INNER JOIN 
(SELECT
 T1.STOCK_MONTH,
 T1.LX_CUST_ORG_ID,
 T1.LX_CUST_ID,
 T1.CUST_TYPE,
 T1.PROD_CODE_P,
 MONTHS_BETWEEN(TO_DATE(CONCAT('${end_date}','-01'),'yyyy-mm-dd'), TO_DATE(T1.VALID_DATE,'yyyy-mm-dd')) AS VAILID_MONTH,
 T1.PROD_MONEY_P,
 T3.FILL_CODE
FROM
 DM_STOCKBYMONTH_TEMP T1
INNER JOIN FILL_BUIN_LX_PROD_NAME T3 ON T1.PROD_CODE_P = T3.PROD_CODE
WHERE T1.VALID_DATE IS NOT NULL
AND T3.FILL_CODE IN ${"("+"'"+replace(gProductType,',',"','")+"'"+")"}
AND T1.STOCK_MONTH ='${end_date}' 
)T3 ON T1.LX_ORG_ID = T3.LX_CUST_ORG_ID
WHERE
 T3.VAILID_MONTH<4


-- 明细表信息--CUST_DETAIL
SELECT DISTINCT
LX_CUST_ORG_ID,
LX_CUST_ID,
LX_TERM_ORG_ID,
TERM_NAME_P,
CUST_TYPE,
MATCH_TYPENAME,
TERM_TYPE_P,
BU_PROD_NAME,
SUM(ROUND(PROD_MONEY_P/'${tth_hex}',1)) OVER (PARTITION BY LX_CUST_ORG_ID,
LX_CUST_ID,
LX_TERM_ORG_ID,
TERM_NAME_P,
CUST_TYPE,
MATCH_TYPENAME,
TERM_TYPE_P,
BU_PROD_NAME) SALE_MONEY,
SUM(PROD_COUNT) OVER (PARTITION BY LX_CUST_ORG_ID,
LX_CUST_ID,
LX_TERM_ORG_ID,
TERM_NAME_P,
CUST_TYPE,
MATCH_TYPENAME,
TERM_TYPE_P,
BU_PROD_NAME) SALE_COUNT
FROM DM_LX_PICTURE
WHERE LX_CUST_ORG_ID IN (
SELECT DISTINCT
  T1.ORG_ID
 FROM
  DIM_LX_ORG T1 
  START WITH ORG_ID  IN
${"("+"'"+replace(gArea,',',"','")+"'"+")"}
   CONNECT BY PRIOR ORG_ID = SUP_ORG_ID
)
AND FILL_CODE IN ${"("+"'"+replace(gProductType,',',"','")+"'"+")"}
AND SALE_MONTH BETWEEN '${start_date}' AND '${end_date}' 
AND CUST_TYPE= '${cust_type}'
AND TERM_TYPE_P IN '${term_type}'
AND (MATCH_TYPENAME IS NULL OR MATCH_TYPENAME = '客户')
UNION
SELECT DISTINCT
LX_CUST_ORG_ID,
LX_CUST_ID,
LX_TERM_ORG_ID,
TERM_NAME_P,
CUST_TYPE,
MATCH_TYPENAME,
TERM_TYPE_P,
BU_PROD_NAME,
SUM(ROUND(PROD_MONEY_P/'${tth_hex}',1)) OVER (PARTITION BY LX_CUST_ORG_ID,
LX_CUST_ID,
LX_TERM_ORG_ID,
TERM_NAME_P,
CUST_TYPE,
MATCH_TYPENAME,
TERM_TYPE_P,
BU_PROD_NAME) SALE_MONEY,
SUM(PROD_COUNT) OVER (PARTITION BY LX_CUST_ORG_ID,
LX_CUST_ID,
LX_TERM_ORG_ID,
TERM_NAME_P,
CUST_TYPE,
MATCH_TYPENAME,
TERM_TYPE_P,
BU_PROD_NAME) SALE_COUNT
FROM DM_LX_PICTURE
WHERE LX_TERM_ORG_ID IN (
SELECT DISTINCT
  T1.ORG_ID
 FROM
  DIM_LX_ORG T1 
  START WITH ORG_ID  IN
${"("+"'"+replace(gArea,',',"','")+"'"+")"}
   CONNECT BY PRIOR ORG_ID = SUP_ORG_ID
)
AND FILL_CODE IN ${"("+"'"+replace(gProductType,',',"','")+"'"+")"}
AND SALE_MONTH BETWEEN '${start_date}' AND '${end_date}' 
AND CUST_TYPE= '${cust_type}'
AND TERM_TYPE_P IN '${term_type}'
AND (MATCH_TYPENAME IS NULL OR MATCH_TYPENAME = '客户')

-- 明细表信息--CUST_ID
WITH T1 AS (
SELECT DISTINCT
  T1.ORG_ID LX_ORG_ID,
  T1.ORG_NAME LX_ORG_NAME,
  T1.SUP_ORG_ID
 FROM
  DIM_LX_ORG T1 
  START WITH ORG_ID IN
${"("+"'"+replace(gArea,',',"','")+"'"+")"} 
   CONNECT BY PRIOR ORG_ID = SUP_ORG_ID
)
SELECT DISTINCT
 T2.LX_CUST_ID,
 T2.LX_CUST_NAME
FROM
 T1
INNER JOIN DM_LX_PICTURE T2 ON T1.LX_ORG_ID = T2.LX_CUST_ORG_ID
WHERE T2.CUST_TYPE = '${cust_type}'
AND T2.SALE_MONTH BETWEEN '${start_date}' AND '${end_date}' 
