-- 基础用户标签监控，共65个
-- 用于监控通过爱互动以及客服手动打标手段添加的用户标签情况
(SELECT -- 国家
  YEAR(tl.develop_time) AS develop_year, 
  MONTH(tl.develop_time) AS develop_month,
  CONCAT("country") AS user_tag,
  tl.country AS tag_attributes,
	COUNT(DISTINCT tl.sys_customer_id) AS customer_id_counts
FROM
  crm_kd.kd_customer tl
GROUP BY
 develop_year,
 develop_month,
 user_tag,
 tag_attributes
ORDER BY
 develop_year,
 develop_month,
 user_tag,
 tag_attributes)
UNION
(SELECT -- 省份
  YEAR(tl.develop_time) AS develop_year, 
  MONTH(tl.develop_time) AS develop_month,
  CONCAT("province") AS user_tag,
  tl.province AS tag_attributes,
	COUNT(DISTINCT tl.sys_customer_id) AS customer_id_counts
FROM
  crm_kd.kd_customer tl
GROUP BY
 develop_year,
 develop_month,
 user_tag,
 tag_attributes
ORDER BY
 develop_year,
 develop_month,
 user_tag,
 tag_attributes)
UNION
(SELECT  -- 城市
  YEAR(tl.develop_time) AS develop_year, 
  MONTH(tl.develop_time) AS develop_month,
  CONCAT("city") AS user_tag,
  tl.city AS tag_attributes,
	COUNT(DISTINCT tl.sys_customer_id) AS customer_id_counts
FROM
  crm_kd.kd_customer tl
GROUP BY
 develop_year,
 develop_month,
 user_tag,
 tag_attributes
ORDER BY
 develop_year,
 develop_month,
 user_tag,
 tag_attributes)
UNION
(SELECT  -- 下单金额
  YEAR(tl.develop_time) AS develop_year, 
  MONTH(tl.develop_time) AS develop_month,
  CONCAT("order_amount") AS user_tag,
  ROUND(tl.order_amount,0) AS tag_attributes,
	COUNT(DISTINCT tl.sys_customer_id) AS customer_id_counts
FROM
  crm_kd.kd_customer tl
GROUP BY
 develop_year,
 develop_month,
 user_tag,
 tag_attributes
ORDER BY
 develop_year,
 develop_month,
 user_tag,
 tag_attributes)
UNION
(SELECT  -- 第一次下单时间
		YEAR (tl.develop_time) AS develop_year,
		MONTH (tl.develop_time) AS develop_month,
		CONCAT("last_order_time") AS user_tag,
		(CASE WHEN ISNULL(tl.last_order_time) THEN 0 ELSE 1 END ) AS tag_attributes,
		COUNT(DISTINCT tl.sys_customer_id) AS customer_id_counts
	FROM
		crm_kd.kd_customer tl
	GROUP BY
		develop_year,
		develop_month,
		user_tag,
		tag_attributes
	ORDER BY
		develop_year,
		develop_month,
		user_tag,
		tag_attributes)
UNION
(SELECT  -- 付款次数
		YEAR (tl.develop_time) AS develop_year,
		MONTH (tl.develop_time) AS develop_month,
		CONCAT("pay_times") AS user_tag,
		 ROUND(tl.pay_times,0) AS tag_attributes,
		COUNT(DISTINCT tl.sys_customer_id) AS customer_id_counts
	FROM
		crm_kd.kd_customer tl
	GROUP BY
		develop_year,
		develop_month,
		user_tag,
		tag_attributes
	ORDER BY
		develop_year,
		develop_month,
		user_tag,
		tag_attributes)
UNION
(SELECT  -- 付款金额
		YEAR (tl.develop_time) AS develop_year,
		MONTH (tl.develop_time) AS develop_month,
		CONCAT("pay_times") AS user_tag,
		 ROUND(tl.pay_times,0) AS tag_attributes,
		COUNT(DISTINCT tl.sys_customer_id) AS customer_id_counts
	FROM
		crm_kd.kd_customer tl
	GROUP BY
		develop_year,
		develop_month,
		user_tag,
		tag_attributes
	ORDER BY
		develop_year,
		develop_month,
		user_tag,
		tag_attributes)
UNION
(SELECT  -- 最后一次付款时间
		YEAR (tl.develop_time) AS develop_year,
		MONTH (tl.develop_time) AS develop_month,
		CONCAT("pay_times") AS user_tag,(CASE WHEN ISNULL(tl.last_order_time) THEN 0 ELSE 1 END ) AS tag_attributes,
		COUNT(DISTINCT tl.sys_customer_id) AS customer_id_counts
	FROM
		crm_kd.kd_customer tl
	GROUP BY
		develop_year,
		develop_month,
		user_tag,
		tag_attributes
	ORDER BY
		develop_year,
		develop_month,
		user_tag,
		tag_attributes)
